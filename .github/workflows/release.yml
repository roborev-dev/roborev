name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
          - goos: windows
            goarch: arm64

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          EXT=""
          if [ "$GOOS" = "windows" ]; then EXT=".exe"; fi

          mkdir -p dist
          LDFLAGS="-s -w -X github.com/roborev-dev/roborev/internal/version.Version=v${VERSION}"
          go build -ldflags="$LDFLAGS" -o dist/roborev${EXT} ./cmd/roborev

          cd dist
          ARCHIVE="roborev_${VERSION}_${{ matrix.goos }}_${{ matrix.goarch }}.tar.gz"
          tar czf "$ARCHIVE" roborev${EXT}
          rm roborev${EXT}

      - uses: actions/upload-artifact@v4
        with:
          name: roborev-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/*.tar.gz

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Generate checksums
        run: |
          cd artifacts
          sha256sum *.tar.gz > SHA256SUMS
          cat SHA256SUMS

      - name: Get tag message
        id: tag_message
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"

          # Only extract message from annotated tags (type "tag"), not lightweight tags (type "commit")
          TAG_TYPE=$(git cat-file -t "$TAG_NAME")
          if [ "$TAG_TYPE" != "tag" ]; then
            echo "Warning: $TAG_NAME is a lightweight tag, using auto-generated notes"
            echo "has_body=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get the tag message body (our changelog), skipping the first line ("Release X.Y.Z")
          TAG_MSG=$(git tag -l --format='%(contents:body)' "$TAG_NAME")

          if [ -n "$TAG_MSG" ]; then
            # Use unique delimiter to avoid conflicts with tag message content
            DELIM="TAGMSG_$(date +%s%N)"
            echo "body<<$DELIM" >> $GITHUB_OUTPUT
            echo "$TAG_MSG" >> $GITHUB_OUTPUT
            echo "$DELIM" >> $GITHUB_OUTPUT
            echo "has_body=true" >> $GITHUB_OUTPUT
          else
            echo "has_body=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/*.tar.gz
            artifacts/SHA256SUMS
          body: ${{ steps.tag_message.outputs.has_body == 'true' && steps.tag_message.outputs.body || '' }}
          generate_release_notes: ${{ steps.tag_message.outputs.has_body != 'true' }}

  update-homebrew:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Compute SHA256 for all binaries
        id: sha256
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # macOS
          echo "darwin_amd64=$(sha256sum artifacts/roborev_${VERSION}_darwin_amd64.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "darwin_arm64=$(sha256sum artifacts/roborev_${VERSION}_darwin_arm64.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT

          # Linux
          echo "linux_amd64=$(sha256sum artifacts/roborev_${VERSION}_linux_amd64.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "linux_arm64=$(sha256sum artifacts/roborev_${VERSION}_linux_arm64.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Checkout tap repository
        uses: actions/checkout@v4
        with:
          repository: wesm/homebrew-taps
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-taps

      - name: Update formula
        env:
          VERSION: ${{ steps.sha256.outputs.version }}
          DARWIN_AMD64_SHA: ${{ steps.sha256.outputs.darwin_amd64 }}
          DARWIN_ARM64_SHA: ${{ steps.sha256.outputs.darwin_arm64 }}
          LINUX_AMD64_SHA: ${{ steps.sha256.outputs.linux_amd64 }}
          LINUX_ARM64_SHA: ${{ steps.sha256.outputs.linux_arm64 }}
        run: |
          cd homebrew-taps

          # Use Ruby to update the formula (more robust than sed for nested blocks)
          ruby -i -e '
            content = File.read("Formula/roborev.rb")

            # Update version
            content.gsub!(/version "[^"]*"/, %Q{version "#{ENV["VERSION"]}"})

            # Track which sha256 values we update
            in_macos = false
            in_linux = false
            in_intel = false
            in_arm = false
            updated = { darwin_amd64: false, darwin_arm64: false, linux_amd64: false, linux_arm64: false }

            lines = content.lines.map do |line|
              # Track block context
              in_macos = true if line.include?("on_macos do")
              in_macos = false if in_macos && line.strip == "end" && !in_intel && !in_arm
              in_linux = true if line.include?("on_linux do")
              in_linux = false if in_linux && line.strip == "end" && !in_intel && !in_arm

              in_intel = true if line.include?("Hardware::CPU.intel?")
              in_arm = true if line.include?("Hardware::CPU.arm?")

              if line.include?("sha256")
                if in_macos && in_intel
                  line = line.gsub(/sha256 "[^"]*"/, %Q{sha256 "#{ENV["DARWIN_AMD64_SHA"]}"})
                  updated[:darwin_amd64] = true
                  in_intel = false
                elsif in_macos && in_arm
                  line = line.gsub(/sha256 "[^"]*"/, %Q{sha256 "#{ENV["DARWIN_ARM64_SHA"]}"})
                  updated[:darwin_arm64] = true
                  in_arm = false
                elsif in_linux && in_intel
                  line = line.gsub(/sha256 "[^"]*"/, %Q{sha256 "#{ENV["LINUX_AMD64_SHA"]}"})
                  updated[:linux_amd64] = true
                  in_intel = false
                elsif in_linux && in_arm
                  line = line.gsub(/sha256 "[^"]*"/, %Q{sha256 "#{ENV["LINUX_ARM64_SHA"]}"})
                  updated[:linux_arm64] = true
                  in_arm = false
                end
              end
              line
            end

            # Verify all checksums were updated
            missing = updated.select { |k, v| !v }.keys
            unless missing.empty?
              STDERR.puts "ERROR: Failed to update sha256 for: #{missing.join(", ")}"
              exit 1
            end

            File.write("Formula/roborev.rb", lines.join)
            puts "Successfully updated formula to v#{ENV["VERSION"]}"
          ' Formula/roborev.rb

          echo "--- Updated formula ---"
          cat Formula/roborev.rb

      - name: Verify checksums in formula
        env:
          DARWIN_AMD64_SHA: ${{ steps.sha256.outputs.darwin_amd64 }}
          DARWIN_ARM64_SHA: ${{ steps.sha256.outputs.darwin_arm64 }}
          LINUX_AMD64_SHA: ${{ steps.sha256.outputs.linux_amd64 }}
          LINUX_ARM64_SHA: ${{ steps.sha256.outputs.linux_arm64 }}
        run: |
          cd homebrew-taps
          ERRORS=0

          for sha in "$DARWIN_AMD64_SHA" "$DARWIN_ARM64_SHA" "$LINUX_AMD64_SHA" "$LINUX_ARM64_SHA"; do
            if ! grep -q "sha256 \"$sha\"" Formula/roborev.rb; then
              echo "ERROR: sha256 $sha not found in formula"
              ERRORS=$((ERRORS + 1))
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            echo "Checksum verification failed"
            exit 1
          fi
          echo "All checksums verified"

      - name: Commit and push
        run: |
          cd homebrew-taps
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes to commit (handles re-runs)
          if git diff --quiet Formula/roborev.rb; then
            echo "No changes to formula, skipping commit"
            exit 0
          fi

          git add Formula/roborev.rb
          git commit -m "Update roborev to v${{ steps.sha256.outputs.version }}"
          git push
