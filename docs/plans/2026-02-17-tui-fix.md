# TUI-Triggered Fix via Background Worktrees

**Status:** Implemented

**Goal:** Allow users to trigger `roborev fix` from the TUI, running agents in isolated background worktrees and applying patches when ready.

**Architecture:** New `fix` job type runs in daemon worker pool using temporary worktrees (same pattern as `refine.go`). Agent produces a patch stored in DB. TUI gets a new Tasks view to monitor fix jobs and apply/rebase patches to the working tree.

**Tech Stack:** Go, SQLite, Bubble Tea TUI, git worktrees

---

## Implementation Summary

### Commits

1. `db3b952` - feat: add fix job type with parent_job_id and patch columns
2. `5b8d6f9` - refactor: extract worktree helpers to internal/worktree package
3. `d62cfbc` - feat: add fix job processing with worktree isolation in worker pool
4. `948b452` - feat: add /api/job/fix and /api/job/patch endpoints
5. `ed7644e` - feat: add TUI Tasks view and fix prompt for background fix jobs
6. `6f48ff5` - feat: add automatic rebase flow for stale fix patches
7. `ca4e4f4` - feat: update help text and hint bars for fix/tasks features

### What Was Built

**Storage Layer (Phase 1)**
- `JobTypeFix = "fix"` constant in `internal/storage/models.go`
- `ParentJobID` and `Patch` fields on `ReviewJob` struct
- `IsFixJob()` helper, updated `UsesStoredPrompt()` to include fix
- DB migration for `parent_job_id` and `patch` columns
- `SaveJobPatch()` function in `internal/storage/jobs.go`

**Worktree Package (Phase 2a)**
- Created `internal/worktree/worktree.go` with shared helpers:
  - `Create(repoPath)` — creates temp worktree detached at HEAD
  - `CapturePatch(worktreeDir)` — stages all changes and returns diff
  - `ApplyPatch(repoPath, patch)` — applies a patch to repo
  - `CheckPatch(repoPath, patch)` — dry-run check if patch applies cleanly
- Extracted from `cmd/roborev/refine.go`, updated refine to use shared package
- Tests moved to `internal/worktree/worktree_test.go`

**Worker Pool (Phase 2b)**
- `processJob()` in `internal/daemon/worker.go` creates isolated worktree for fix jobs
- Agent runs in worktree, patch captured after completion and saved to DB

**API Endpoints (Phase 3)**
- `POST /api/job/fix` — creates background fix job from parent review
  - Accepts `parent_job_id` (required) and `prompt` (optional override)
  - Builds fix prompt from parent review output if no custom prompt
- `GET /api/job/patch?job_id=N` — returns stored patch as plain text

**TUI (Phase 4)**
- **Tasks View** (`T` key) — shows fix jobs with status (queued/running/done/failed)
- **Fix Prompt** (`F` key from queue/review) — opens modal to trigger fix for selected review
- **Apply Patch** (`A` key in Tasks view) — applies patch with dry-run check first
- **Rebase** — automatic when `git apply --check` fails: triggers new fix job with stale patch as context
- **Manual Rebase** (`R` key in Tasks view) — manually re-trigger fix with rebase prompt
- **Tail** (`t` key in Tasks view) — tail running fix job output
- **Cancel** (`x` key in Tasks view) — cancel running/queued fix job

**Help and Hints (Phase 5)**
- Updated `helpLines()` with Tasks View section and F/T in Actions
- Queue hint bar: added `F: fix` and `T: tasks`
- Tasks hint bar: `A: apply | R: rebase | t: tail | x: cancel | r: refresh | T/esc: back`
- Fix prompt hint bar: `enter: start fix | esc: cancel`

### Flow

1. User views a review in the TUI, presses `F` to trigger a fix
2. Fix prompt modal shows pre-built prompt, user presses `enter` to confirm
3. Daemon enqueues a `fix` job, runs agent in isolated worktree
4. Agent makes changes, worktree diff captured as patch, stored in DB
5. User presses `T` to see Tasks view, sees fix job complete
6. User presses `A` to apply — dry-run check runs first:
   - **Clean:** patch applied to working tree
   - **Stale:** automatically triggers new fix job with stale patch as context (rebase)
7. User can press `R` to manually trigger rebase for any completed fix

### Not Implemented (Future Work)

- **Refine mode from TUI** — iterative review-fix loop (fix → re-review → fix until pass)
- **Dry-run staleness indicator** — showing green/yellow status on completed fix jobs in Tasks view
- **Patch preview** — rendering the diff in a scroll view before applying
